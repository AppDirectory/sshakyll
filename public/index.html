<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Editor</title>

  <script type="text/javascript" src="/promise-0.1.1.min.js"></script>
  <script type="text/javascript" src="/jquery-2.1.0.min.js"></script>
  <script type="text/javascript" src="/jstree/jstree.min.js"></script>
  <link rel="stylesheet" href="/jstree/themes/default/style.min.css">

  <script src="/markdown-it.js"></script>
  <script src="/markdown-it-footnote.js"></script>
  <script src="/highlight.pack.js"></script>
  <link rel="stylesheet" href="/default.css">

  <style type="text/css" media="screen">
    body {
      overflow: hidden;
      margin: 0;
    }

    #editor {
      position: fixed;
      top: 0;
      left: 250px;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }

    #in {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 50%;
      height: auto;
      overflow: auto;
      font-size: 12px;
      box-shadow: -10px 2px 6px 10px rgba(0,0,0,0.4);
    }

    #in.uninitialized {
      background-color: #ebebeb;
    }

    #in.no-preview {
        width: 100%;
        right: 10px;
    }

    #out {
      position: absolute;
      top: 0;
      right: 0;
      left: 50%;
      bottom: 0;
      overflow: auto;
      padding: 10px;
      padding-left: 20px;
      color: #444;
      font-family:Georgia, Palatino, 'Palatino Linotype', Times, 'Times New Roman', serif;
      font-size: 16px;
      line-height: 1.5em;
      display: none;
    }

    @media screen and (max-width: 1024px) {
      #in {
        width: 100%;
        right: 10px;
      }
      #out {
        display: none;
      }
    }

    a{ color: #0645ad; text-decoration:none;}
    a:visited{ color: #0b0080; }
    a:hover{ color: #06e; }
    a:active{ color:#faa700; }
    a:focus{ outline: thin dotted; }
    a:hover, a:active{ outline: 0; }

    p{margin:1em 0;}

    img{max-width:100%;}

    h1,h2,h3,h4,h5,h6{font-weight:normal;color:#111;line-height:1em;}
    h4,h5,h6{ font-weight: bold; }
    h1{ font-size:2.5em; }
    h2{ font-size:2em; border-bottom:1px solid silver; padding-bottom: 5px; }
    h3{ font-size:1.5em; }
    h4{ font-size:1.2em; }
    h5{ font-size:1em; }
    h6{ font-size:0.9em; }

    blockquote{color:#666666;margin:0;padding-left: 3em;border-left: 0.5em #EEE solid;}
    hr { display: block; height: 2px; border: 0; border-top: 1px solid #aaa;border-bottom: 1px solid #eee; margin: 1em 0; padding: 0; }

    pre, code{
      color: #000;
      font-family:Consolas, "Liberation Mono", Menlo, Courier, monospace;
      font-size: 0.94em; /* 0.94 = 0.88 + (1.00 - 0.88) / 2 */
      border-radius:3px;
      background-color: #F8F8F8;
      border: 1px solid #CCC;
    }
    pre { white-space: pre; white-space: pre-wrap; word-wrap: break-word; padding: 5px;}
    pre code { border: 0px !important; background: transparent !important; line-height: 1.3em; }
    code { padding: 0 3px 0 3px; }
    sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
    sup { top: -0.5em; }
    sub { bottom: -0.25em; }
    ul, ol { margin: 1em 0; padding: 0 0 0 2em; }
    li p:last-child { margin:0 }
    dd { margin: 0 0 0 2em; }
    img { border: 0; -ms-interpolation-mode: bicubic; vertical-align: middle; }
    table { border-collapse: collapse; border-spacing: 0; }
    td, th { vertical-align: top; padding: 4px 10px; border: 1px solid #bbb; }
    tr:nth-child(even) td, tr:nth-child(even) th { background: #eee; }

    #sidebar {
      margin: 0;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: 249px;
      border-right: 1px solid #888;
    }

    #status {
      height: 99px;
    }

    #status button {
      height: 20px;
      font-size: 14px;
      line-height: 14px;
      padding: 2px 8px;
      border: none;
      border-radius: 3px;
      background-color: #aaa;
      margin: 2px 0;
    }
    #status button:disabled {
      color: #666;
    }

    #status button:hover {
      background-color: white;
      cursor: pointer;
    }
    #status button:hover:disabled {
      background-color: #aaa;
      cursor: auto;
    }

    #tree {
      position: fixed;
      overflow-x: hidden;
      overflow-y: auto;
      top: 100px;
      bottom: 0;
      left: 0;
      width: 249px;
    }

    #status {
      background-color: #ebebeb;
      text-align: center;
      white-space: nowrap;
      border-bottom: 1px solid #888;
    }

    #save-error {
      color: red;
    }

    #howto {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      display: none;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
    }

    #howto>div {
      position: fixed;
      top: 100px;
      left: 100px;
      right: 100px;
      background-color: white;
      padding: 50px;
      border: 1px solid black;
      font-family: sans-serif;
    }

    #howto.shown {
      display: block;
    }

    #showPreview, #hidePreview {
      display: none;
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div id="status">
    <button id="publish" onclick="publish()">Publish</button>
    <button id="new" onclick="newDoc()">New</button>
    <button id="delete" onclick="deleteDoc()">Delete</button>
    <button id="save" onclick="saveCurrent()" disabled>Saved</button><br>
    <button id="upload" onclick="uploadFile()">Upload</button>
    <button id="uploadArchive" onclick="uploadFile(true)">Upload Archive</button><br>
    <button id="showHowto" onclick="showHowto()">Setup DNS</button>
    <button id="showPreview" onclick="showPreview()">Preview</button>
    <button id="hidePreview" onclick="hidePreview()">Hide Preview</button>
    <span id="save-error"></span>
    <div id="currentDirectory"></div>
  </div>
  <div id="tree"></div>
</div>

<div id="editor">
  <div id="in" class="uninitialized no-preview"></div>
  <div id="out"></div>
</div>

<div id="howto">
  <div>
    <p id="howto-auto-url">Your site is available at: <a target="_blank" id="howto-auto-url-link"></a>
    <div id="howto-demo">
      <p>If you weren't using a demo account, you could additionally publish the site to an
        arbitrary domain you control.
    </div>
    <div id="howto-nondemo">
      <p>To set up your domain to point at your published site, add the following DNS records to
        your domain. Replace <code>host.example.com</code> with your site's hostname.
      <pre>  host.example.com IN CNAME <span id="howto-hostname">hostname</span>
  sandstorm-www.host.example.com IN TXT <span id="howto-id">id</span></pre>
      <p>Note: If your site may get a lot of traffic, consider putting it behind a CDN.
        <a href="https://cloudflare.com" target="_blank">CloudFlare</a>, for example, can do this for free.
    </div>
    <p><button onclick="hideHowto()">Close</button>
  </div>
</div>

<script type="text/javascript" src="/utils.js"></script>
<script type="text/javascript">

var saveState = "saved";
var savePromise = Promise.resolve(undefined);

function saved() {
  if (saveState === "saving") {
    $("#save").text("Saved");
    saveState = "saved";
  }
}

function saving() {
  $("#save").prop("disabled", true).text("Saving...");
  saveState = "saving";
}

var saveTimeout;
function unsaved() {
  saveState = "unsaved";
  $("#save").prop("disabled", false).text("Save");
  if (saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveCurrent, 1000);
}

var currentPath;
var currentDirectory = "";
function saveCurrent() {
  $("#save-error").text();
  if (currentPath && saveState === "unsaved") {
    saving();
    if (!isTextFile(currentPath)) {
      return new Promise(function(resolve, reject) {
        console.error("Can't save un text filed");
        reject("Save failed!");
      });
    }
    savePromise = doPut("/api/file" + currentPath, editor.getValue()).then(function (response) {
      saved();
    }, function (err) {
      console.error(err);
      $("#save-error").text("Save failed!");
      unsaved();
    });
  }
  return savePromise;
}

function newDoc() {
  saveCurrent().then(function () {
    var filename = window.prompt("Enter file name.");
    if (filename) {
      path = currentDirectory + "/" + filename;

      if (!isTextFile(path)) {
        path = path + '.md';
      }

      catchErrors(doPut("/api/file" + path, "\n").then(function (response) {
        $("#tree").jstree(true).destroy();
        $("#tree").empty();
        initTree();
      }));
    }
  });
}

function uploadFile(isArchive) {
  api = '/api/file'
  if (isArchive) {
    api = '/api/archive'
  }

  // Can't saveCurrent first because you can't trigger DOM events (ie. click) inside Promises

  var form = $('<form><input type="file" name="test"></form>', { css: { 'display': 'none' }});
  var input = $(form.children()[0]);

  input.on('change', function(e) {
    $.each(this.files, function(key, file) {
      var filePath = currentDirectory + "/" + file.name;
      catchErrors(doPut(api + filePath, file).then(function (response) {
        $("#tree").jstree(true).destroy();
        $("#tree").empty();
        initTree();
      }));
    });
  });

  // Trigger file selector (only works on newer browsers...)
  input.click();
}

function deleteDoc() {
  var selected = $("#tree").jstree(true).get_selected(true)[0];
  if (!selected) {
    window.alert("You must select a file to delete.");
    return;
  }

  var path = selected.original.serverPath;
  if (window.confirm("Delete " + path + "?")) {
    doDelete("/api/file" + path).then(function (response) {
      $("#tree").jstree(true).destroy();
      $("#tree").empty();
      if (selected.original.isDir) {
        currentDirectory = path.substr(0, path.lastIndexOf('/'));
      }
      initTree();
    }).catch(function(err) {
      window.alert('Delete directory failed. because it is not empty.');
    });
  }
}

function publish() {
  if (window.confirm("Publish now?")) {
    doPost("/api/publish", "");
  }
}

function filesToTree(parent, files) {
  var result = [];
  for (var file in files) {
    var content = files[file];
    var entry = {text: file};
    var path = parent + "/" + file;
    entry.serverPath = path;
    if (typeof content === "object") {
      entry.children = filesToTree(path, content);
      entry.state = { "opened": false };
      entry.isDir = true;
    } else {
      entry.icon = false;
      entry.isDir = false;
    }
    result.push(entry);
  }
  return result;
}

function initTree() {
  $("#currentDirectory").html(currentDirectory);
  doGet("/api/file").then(function (xhr) {
    var data = JSON.parse(xhr.responseText);
    $("#tree").on("activate_node.jstree", function (e, data) {
      if (!data.node.original.isDir) {
        var serverPath = data.node.original.serverPath;
        currentDirectory = serverPath.substr(0, serverPath.lastIndexOf('/'));

        if (isTextFile(serverPath)) {
          catchErrors(saveCurrent().then(function () {
            return doGet("/api/file" + serverPath);
          }).then(function (xhr) {
            currentPath = serverPath;
            if (!editorInitialized) initEditor();
            editor.removeAllListeners("change");
            editor.setValue(xhr.responseText, -1);
            editor.on("change", unsaved);
            editor.on("change", update);
            setEditorMode(xhr.getResponseHeader("content-type"), serverPath);
            setTimeout(update, 100);
          }));
        } else if (isImageFile(serverPath)) {
            setEditorCustomData("![Image Title](" + serverPath + ")");
        } else {
            setEditorCustomData("[File Title](" + serverPath + ")");
        }
      } else {
        currentDirectory = data.node.original.serverPath;
      }
      $("#currentDirectory").html(data.node.original.serverPath);
    }).jstree({core: {data: filesToTree("", data)}});
  });
}

function setEditorCustomData(data) {
  if (!editorInitialized) initEditor();
  editor.removeAllListeners("change");
  editor.on("change", update);
  editor.setValue(data, -1);
  setEditorMode("", "test.md");
  setTimeout(update, 100);
}

$(function () {
  initTree();
});

function showHowto() {
  doGet("/api/publicId").then(function (xhr) {
    var lines = xhr.responseText.split('\n');
    var info = {
      autoUrl: lines[2],
      hostname: /https?:\/\/([^\/]+)/i.exec(lines[2])[1],
      publicId: lines[0],
      isDemoUser: lines[3] === 'true'
    };
    var url = document.createElement("a");
    url.href = info.autoUrl;
    $("#howto-hostname").text(url.hostname);
    $("#howto-id").text(info.publicId);
    $("#howto").addClass("shown");
    var link = $("#howto-auto-url-link");
    link.text(info.autoUrl);
    link.attr("href", info.autoUrl);
    $("#howto-auto-url").show();
    if (info.isDemoUser) {
      $("#howto-demo").show();
      $("#howto-nondemo").hide();
    } else {
      $("#howto-demo").hide();
      $("#howto-nondemo").show();
    }
  });
}

function hideHowto() {
  $("#howto").removeClass("shown");
}

var preview = true;
var canPreview = false;
function showPreview() {
  preview = true;
  $("#out").show();
  $("#in").removeClass("no-preview");
  $("#hidePreview").show();
  $("#showPreview").hide();
  editor.resize()
}

function hidePreview() {
  preview = false;
  $("#out").hide();
  $("#in").addClass("no-preview");
  $("#hidePreview").hide();
  $("#showPreview").show();
  editor.resize()
}

function disablePreview() {
  canPreview = false;
  $("#hidePreview").hide();
  $("#showPreview").hide();
  $("#out").hide();
  $("#in").addClass("no-preview");
}

function enablePreview() {
  canPreview = true;
  if (preview) {
    showPreview();
  } else {
    hidePreview();
  }
}

// Because highlight.js is a bit awkward at times
var languageOverrides = {
  js: 'javascript',
  html: 'xml'
};

var md = markdownit({
  html: true,
  highlight: function(code, lang){
    if(languageOverrides[lang]) lang = languageOverrides[lang];
    if(lang && hljs.getLanguage(lang)){
      try {
        return hljs.highlight(lang, code).value;
      }catch(e){}
    }
    return '';
  }
})
  .use(markdownitFootnote);


function update(e){
  var mode = editor.getSession().getMode().$id;
  if (/markdown|xml|html|text/i.exec(mode) && !/^\/editor/i.exec(currentPath)) {
    if (!canPreview) {
      enablePreview();
    }
    setOutput(editor.getValue(), mode);
  } else {
    if (canPreview) {
      disablePreview();
    }
  }
}

function setOutput(val, mode){
  var out = document.getElementById('out');
  var old = out.cloneNode(true);
  if (/markdown/i.exec(mode)) {
    out.innerHTML = md.render(val);
  } else {
    out.innerHTML = val;
  }

  var allold = old.getElementsByTagName("*");
  if (allold === undefined) return;

  var allnew = out.getElementsByTagName("*");
  if (allnew === undefined) return;

  for (var i = 0, max = Math.min(allold.length, allnew.length); i < max; i++) {
    if (!allold[i].isEqualNode(allnew[i])) {
      out.scrollTop = allnew[i].offsetTop;
      return;
    }
  }
}

</script>
<script src="/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
var editorInitialized = false;
var editor;

var MODE_MAP = {
  "text/javascript": "javascript",
  "text/x-markdown": "markdown",
  "text/html": "html",
  "text/css": "css",
  "text/yaml": "yaml",
  "text/plain": "text",
  "image/svg+xml": "xml",
  "application/json": "json"
};

function getModeFromFileName(fileName) {
  var mode = "text";
  if (/\.js$/i.exec(fileName)) {
    mode = 'javascript';
  }
  if (/\.(md|markdown|rst)/i.exec(fileName)) {
    mode = 'markdown';
  }
  if (/\.css$/i.exec(fileName)) {
    mode = 'css'
  }
  return mode;
}

function setEditorMode(mimeType, fileName) {
  var semiPos = mimeType.indexOf(";");
  if (semiPos >= 0) {
    mimeType = mimeType.slice(0, semiPos);
  }
  mimeType = mimeType.trim();

  if (mimeType in MODE_MAP) {
    editor.getSession().setMode("ace/mode/" + MODE_MAP[mimeType]);
  } else {
    editor.getSession().setMode("ace/mode/" + getModeFromFileName(fileName));
  }
}

function initEditor() {
  $("#in").removeClass("uninitialized");
  editor = ace.edit("in");
  editor.setTheme("ace/theme/chrome");
  editorInitialized = true;
}
</script>
</body>
</html>

